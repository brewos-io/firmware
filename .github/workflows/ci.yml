# Unified CI workflow for PRs
# This workflow runs on all PRs and is the single required status check
name: "PR: Continuous Integration"

on:
  pull_request:
    branches: ["main"]
  workflow_dispatch:

# Cancel in-progress runs for the same PR
concurrency:
  group: ci-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # ==========================================================================
  # Detect what changed to conditionally run jobs
  # ==========================================================================
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      pico: ${{ steps.filter.outputs.pico }}
      esp32: ${{ steps.filter.outputs.esp32 }}
    steps:
      - uses: actions/checkout@v6
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            pico:
              - 'src/pico/**'
              - 'src/shared/**'
            esp32:
              - 'src/esp32/**'
              - 'src/shared/**'

  # ==========================================================================
  # Pico Firmware - Unit Tests + Build
  # ==========================================================================
  pico:
    name: Pico Firmware
    needs: changes
    if: needs.changes.outputs.pico == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-arm-none-eabi libnewlib-arm-none-eabi build-essential cmake

      - name: Run Unit Tests
        run: |
          cd src/pico/test
          mkdir -p build && cd build
          cmake ..
          make -j$(nproc)
          ./brewos_tests

      - name: Clone Pico SDK
        run: |
          git clone --depth 1 https://github.com/raspberrypi/pico-sdk.git ~/pico-sdk
          cd ~/pico-sdk && git submodule update --init

      - name: Build Firmware
        env:
          PICO_SDK_PATH: ~/pico-sdk
        run: |
          cd src/pico
          mkdir build && cd build
          cmake -DBUILD_ALL_MACHINES=ON ..
          make -j$(nproc)

      - name: Verify Output
        run: |
          cd src/pico/build
          test -f brewos_dual_boiler.uf2
          test -f brewos_single_boiler.uf2
          test -f brewos_heat_exchanger.uf2
          echo "✓ All firmware variants built"

  # ==========================================================================
  # ESP32 Firmware - Build
  # ==========================================================================
  esp32:
    name: ESP32 Firmware
    needs: changes
    if: needs.changes.outputs.esp32 == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Checkout App Repository
        uses: actions/checkout@v6
        with:
          repository: brewos-io/app
          path: app
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: app/package-lock.json

      - name: Build App for ESP32
        run: |
          cd app
          npm ci
          # Clean old files before build (prevent stale hashed assets)
          rm -rf ../src/esp32/data/assets ../src/esp32/data/index.html ../src/esp32/data/*.svg ../src/esp32/data/*.png ../src/esp32/data/*.json ../src/esp32/data/sw.js 2>/dev/null || true
          ESP32_DATA_DIR=../src/esp32/data npm run build:esp32

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Install PlatformIO
        run: pip install platformio pyyaml

      - name: Build ESP32
        run: |
          cd src/esp32
          pio run -e esp32s3

      - name: Build LittleFS
        run: |
          cd src/esp32
          pio run -e esp32s3 -t buildfs

  # ==========================================================================
  # Final Status Check (always runs, reports overall status)
  # ==========================================================================
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [changes, pico, esp32]
    if: always()
    steps:
      - name: Check Results
        run: |
          echo "=== CI Results ==="
          echo "Pico:  ${{ needs.pico.result || 'skipped' }}"
          echo "ESP32: ${{ needs.esp32.result || 'skipped' }}"

          # Fail if any required job failed
          if [[ "${{ needs.pico.result }}" == "failure" ]] || \
             [[ "${{ needs.esp32.result }}" == "failure" ]]; then
            echo "❌ CI Failed"
            exit 1
          fi

          echo "✅ CI Passed"
